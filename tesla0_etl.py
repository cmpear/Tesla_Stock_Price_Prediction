import pandas as pd
import os
import datetime
import numpy as np
####################################################################################################################################################
####################################################################################################################################################
# FUNCTIONS #
####################################################################################################################################################
####################################################################################################################################################
####################################################################################################################################################
# ensure_dir_exists: checks a target director to make a file, creates it
#                    if it does not exist
####################################################################################################################################################
def ensure_dir_exists(dir):
    if not os.path.exists(dir):
            os.makedirs(dir)
####################################################################################################################################################
####################################################################################################################################################
# MAIN #
####################################################################################################################################################
####################################################################################################################################################
####################################################################################################################################################
# ETL #
####################################################################################################################################################
this_dir = os.path.dirname(os.path.realpath('__file__') )
target_dir = os.path.join(this_dir, 'data/TSLA.csv')
TSLA = pd.read_csv(target_dir, delimiter=',') 
####################################################################################################################################################
# FEATURE CREATION #
####################################################################################################################################################
TSLA.columns = ['date','open','high','low','close','adj_close','volume']
TSLA['date'] = pd.to_datetime(TSLA.date)
TSLA['daily_change'] = TSLA['close'].shift(periods = 1)
TSLA.loc[0,'daily_change'] = TSLA.loc[0,'open']
TSLA['daily_change'] = TSLA['close'] - TSLA['daily_change']
TSLA['days_after_ipo'] = TSLA.date - datetime.datetime(2010, 1, 29)
TSLA.days_after_ipo = TSLA.days_after_ipo // np.timedelta64(1, 'D')
TSLA.days_after_ipo = TSLA.days_after_ipo.astype('int')

####################################################################################################################################################
# SAVE CLEANED DATA #
####################################################################################################################################################
this_dir = os.path.dirname(os.path.realpath('__file__') )
target_dir = os.path.join(this_dir, 'TSLA/')
ensure_dir_exists(target_dir)
target_dir = os.path.join(target_dir, 'TSLA.csv')
TSLA.to_csv(target_dir, index = False)   # index = False does not always work when run...